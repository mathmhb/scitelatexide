# Make file for Scintilla on Windows
# Copyright 1998-2003 by Neil Hodgson <neilh@scintilla.org>
# The License.txt file describes the conditions under which this software may be distributed.
# This makefile assumes the mingw32 version of GCC 2.95.3 is used and changes will
# be needed to use other compilers.
# The -fvtable-thunks option is required for older (2.9*) versions of gcc but can be removed
# safely if using a newer version which may display warning messages.

.SUFFIXES: .cxx

# MINGWVERSION is used to specify which version of MINGW is to be used to do the cross compiling.
# Two versions are available: i386-mingw32-4.3.0 and i386-mingw32-3.4.5

MINGWVERSION = i386-mingw32-3.4.5
CC = /usr/local/$(MINGWVERSION)/bin/i386-mingw32-g++
DLLWRAP = /usr/local/$(MINGWVERSION)/bin/i386-mingw32-dllwrap
DEL = rm -f
WINDRES = /usr/local/$(MINGWVERSION)/bin/i386-mingw32-windres
RANLIB = /usr/local/$(MINGWVERSION)/bin/i386-mingw32-ranlib

COMPONENT = ../bin/Scintilla.dll
LEXCOMPONENT = ../bin/SciLexer.dll
LEXLIB = Lexers.a

ifndef NOTHUNKS
gversion = $(word 1,$(subst ., ,$(shell /usr/local/$(MINGWVERSION)/bin/i386-mingw32-g++ --version)))
ifeq ($(gversion),2)
THUNKFLAGS=-fvtable-thunks
endif
endif

vpath %.h ../src ../include
vpath %.cxx ../src

LDFLAGS=-mwindows -lstdc++ -limm32 -lole32 -luuid -mno-cygwin
# Add -MMD to get dependencies
#CXXFLAGS = -g -pg -pedantic -Os -fexceptions -fvtable-thunks -fno-rtti
INCLUDEDIRS=-I ../include -I ../src
CXXBASEFLAGS=-Wall -Wno-missing-braces -Wno-char-subscripts -pedantic $(INCLUDEDIRS) -Os -fexceptions $(THUNKFLAGS) -fno-rtti -mno-cygwin

ifdef DEBUG
CXXFLAGS=-DDEBUG -g $(CXXBASEFLAGS)
else
CXXFLAGS=-DNDEBUG -Os $(CXXBASEFLAGS)
STRIPFLAG=-s
endif

.cxx.o:
	$(CC) $(CXXFLAGS) -c $<

## [mhb] 07/11/09 : run gen_lexers to generate _lexers.inc first
ALL:	gen_lexers $(COMPONENT) $(LEXCOMPONENT) $(LEXLIB) ScintillaWinS.o WindowAccessor.o

clean:
	$(DEL) *.exe *.o *.obj *.dll *.res *.map

deps:
	$(CC) -MM $(CXXFLAGS) *.cxx ../src/*.cxx >deps.mak

## [mhb] 07/11/09 : use less lexers to reduce exe file size if LESS_LEXERS is defined
ifdef LESS_LEXERS
LEXERS=Ada Asm ASY AU3 Bash Basic BiB Cmake COBOL Conf CPP \
Crontab CSS D Eiffel Erlang EScript Euphoria Flagship Forth Fortran Gui4Cli \
HTML Inno Kix Latex Lisp Lout Lua Markdown Matlab Metapost MSSQL MySQL Nsis Others\
Pascal PB Perl PowerPro PowerShell PS Python R Rebol Ruby Smalltalk SQL TCL VB
else
LEXERS=\
ABAP Abaqus Ada APDL Asm Asn1 ASY AU3 \
AVE Baan Bash Basic BiB Bullant Caml \
CLW Cmake COBOL Conf CPP Crontab Csound \
CSS D Eiffel Erlang EScript Euphoria \
Flagship Forth Fortran GAP Gui4Cli Haskell \
HTML Inno Kix Latex Lisp Lout Lua \
Magik Markdown Matlab Metapost MMIXAL MPT MSSQL \
MySQL Nimrod Nsis Opal Others Pascal PB \
Perl PLM POV PowerPro PowerShell Progress \
PS Python R Rebol Ruby Scriptol Smalltalk \
SML Sorcus Specman Spice SQL TACL TADS3 \
TAL TCL VB Verilog VHDL YAML
endif
## [mhb] 07/11/09 : now there is no need to explicitly specify Lex*.o; you need just place wanted lexers above:-)
LEXOBJS=$(LEXERS:%=Lex%.o)
## [mhb] 07/11/09 : the following codes generate correct table of lexer names
LEXNAMS:=$(LEXERS:Basic=BlitzBasic PureBasic FreeBasic)
LEXNAMS:=$(LEXNAMS:CLW=Clw ClwNoCase)
LEXNAMS:=$(LEXNAMS:CPP=CPP CPPNoCase)
LEXNAMS:=$(LEXNAMS:Crontab=Nncrontab)
LEXNAMS:=$(LEXNAMS:CSS=Css)
LEXNAMS:=$(LEXNAMS:Eiffel=Eiffel Eiffelkw)
LEXNAMS:=$(LEXNAMS:EScript=ESCRIPT)
LEXNAMS:=$(LEXNAMS:Flagship=FlagShip)
LEXNAMS:=$(LEXNAMS:Fortran=Fortran F77)
LEXNAMS:=$(LEXNAMS:HTML=HTML XML PHPSCRIPT)
LEXNAMS:=$(LEXNAMS:Lisp=LISP)
LEXNAMS:=$(LEXNAMS:Magik=MagikSF)
LEXNAMS:=$(LEXNAMS:Matlab=Matlab Octave)
LEXNAMS:=$(LEXNAMS:Metapost=METAPOST)
LEXNAMS:=$(LEXNAMS:MPT=Lot)
LEXNAMS:=$(LEXNAMS:Others=Batch Diff Po Props Make ErrorList Null)
LEXNAMS:=$(LEXNAMS:Rebol=REBOL)
LEXNAMS:=$(LEXNAMS:Sorcus=Sorc)
LEXNAMS:=$(LEXNAMS:VB=VB VBScript)

## [mhb] 07/11/09 : now we do not need to specify what lexers should be linked; we generate the list automatically!
gen_lexers:
	rm -f KeyWords.o
	rm -f ../src/_lexers.inc
	for lex in $(LEXNAMS); do echo "LINK_LEXER(lm$$lex);">>../src/_lexers.inc; done
# KeyWords.o: KeyWords.cxx _lexers.inc


SOBJS	= ScintillaWin.o ScintillaBase.o Editor.o CharClassify.o Decoration.o \
	Document.o ContractionState.o CellBuffer.o CallTip.o \
	ScintRes.o PlatWin.o PositionCache.o KeyMap.o Indicator.o LineMarker.o RESearch.o RunStyles.o \
	Selection.o Style.o ViewStyle.o AutoComplete.o UniConversion.o PropSet.o XPM.o PerLine.o
$(COMPONENT): $(SOBJS) Scintilla.def
	$(DLLWRAP) --add-stdcall-alias --target i386-mingw32 -o $@ $(SOBJS) $(LDFLAGS) $(STRIPFLAG) --relocatable

LOBJS	= ScintillaWinL.o ScintillaBaseL.o Editor.o CharClassify.o Decoration.o \
	Document.o ContractionState.o CellBuffer.o CallTip.o \
	ScintRes.o PlatWin.o PositionCache.o KeyMap.o Indicator.o LineMarker.o RESearch.o RunStyles.o \
	Selection.o Style.o ViewStyle.o AutoComplete.o UniConversion.o KeyWords.o \
	DocumentAccessor.o PropSet.o ExternalLexer.o StyleContext.o XPM.o PerLine.o $(LEXOBJS)
$(LEXCOMPONENT): $(LOBJS) Scintilla.def
	$(DLLWRAP) --add-stdcall-alias --target i386-mingw32 -o $@ $(LOBJS) $(LDFLAGS) $(STRIPFLAG) --relocatable

$(LEXLIB): $(LEXOBJS)
	$(AR) rc $@ $^
	$(RANLIB) $@

# Automatically generate dependencies for most files with "make deps"
include deps.mak

# These dependencies are maintained by hand as they do not use the default output name
ScintillaBaseL.o: ScintillaBase.cxx Platform.h Scintilla.h SciLexer.h \
 ContractionState.h CellBuffer.h CallTip.h KeyMap.h Indicator.h \
 LineMarker.h Style.h AutoComplete.h ViewStyle.h Document.h Editor.h \
 ScintillaBase.h PropSet.h Accessor.h DocumentAccessor.h \
 KeyWords.h ExternalLexer.h PerLine.h
ScintillaWinL.o: ScintillaWin.cxx Platform.h Scintilla.h SciLexer.h \
 ContractionState.h CellBuffer.h CallTip.h KeyMap.h Indicator.h \
 LineMarker.h Style.h AutoComplete.h ViewStyle.h Document.h Editor.h \
 ScintillaBase.h PropSet.h Accessor.h KeyWords.h \
 ExternalLexer.h UniConversion.h PerLine.h
ScintillaWinS.o: ScintillaWin.cxx Platform.h Scintilla.h \
 ContractionState.h CellBuffer.h CallTip.h KeyMap.h Indicator.h \
 LineMarker.h Style.h AutoComplete.h ViewStyle.h Document.h Editor.h \
 ScintillaBase.h UniConversion.h PerLine.h

ScintillaBaseL.o:
	$(CC) $(CXXFLAGS) -D SCI_LEXER -c $< -o $@

ScintillaWinS.o:
	$(CC) $(CXXFLAGS) -D STATIC_BUILD -c $< -o $@

ScintillaWinL.o:
	$(CC) $(CXXFLAGS) -D SCI_LEXER -c $< -o $@

ScintRes.o:	ScintRes.rc PlatformRes.h
	$(WINDRES) ScintRes.rc $@

